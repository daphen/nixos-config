#!/bin/bash
# 1Password userscript - fill PASSWORD only

DOMAIN=$(echo "$QUTE_URL" | sed -E 's|https?://([^/]+).*|\1|' | sed 's/^www\.//')
ITEM=$(op item list --format=json 2>/dev/null | jq -r ".[] | select(.urls[]?.href | test(\"$DOMAIN\"; \"i\")) | .id" | head -1)

if [ -z "$ITEM" ]; then
    echo "message-error 'No 1Password item found for $DOMAIN'" >> "$QUTE_FIFO"
    exit 1
fi

PASSWORD=$(op item get "$ITEM" --fields password --reveal 2>/dev/null)

if [ -z "$PASSWORD" ]; then
    echo "message-error '1Password: No password found'" >> "$QUTE_FIFO"
    exit 1
fi

echo "insert-text $PASSWORD" >> "$QUTE_FIFO"
echo "message-info '1Password: Filled password'" >> "$QUTE_FIFO"
