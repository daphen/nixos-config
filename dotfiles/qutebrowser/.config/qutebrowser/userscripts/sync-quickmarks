#!/bin/bash
# Sync links from synced app to qutebrowser bookmarks

# Load database URL from synced .env
ENV_FILE="$HOME/personal/synced/.env"
if [[ ! -f "$ENV_FILE" ]]; then
    echo "message-error 'Sync: .env file not found'" >> "$QUTE_FIFO"
    exit 1
fi

DATABASE_URL=$(grep -E "^POSTGRES_URL=" "$ENV_FILE" | cut -d'=' -f2- | tr -d '"' | sed 's/&supa=[^&]*//')
DATABASE_URL=${DATABASE_URL:-$(grep -E "^DATABASE_URL=" "$ENV_FILE" | cut -d'=' -f2- | tr -d '"')}

if [[ -z "$DATABASE_URL" ]]; then
    echo "message-error 'Sync: DATABASE_URL not found in .env'" >> "$QUTE_FIFO"
    exit 1
fi

# Delete existing bookmarks first
BOOKMARKS_FILE="$HOME/.config/qutebrowser/bookmarks/urls"
if [[ -f "$BOOKMARKS_FILE" ]]; then
    while read -r line; do
        url=$(echo "$line" | cut -d' ' -f1)
        if [[ -n "$url" ]]; then
            echo "bookmark-del $url" >> "$QUTE_FIFO"
        fi
    done < "$BOOKMARKS_FILE"
fi

sleep 0.3

# Query links from database, add via bookmark-add, and build file with titles
count=0
TEMP_FILE=$(mktemp)
while IFS=$'\t' read -r title url; do
    clean_title=$(echo "$title" | tr -cd '[:alnum:] /_-' | sed 's/  */ /g' | head -c 50)
    echo "bookmark-add \"$url\" \"$clean_title\"" >> "$QUTE_FIFO"
    echo "$url $clean_title" >> "$TEMP_FILE"
    count=$((count + 1))
done < <(psql "$DATABASE_URL" -t -A -F $'\t' -c "
    SELECT
        COALESCE(NULLIF(title, ''), REGEXP_REPLACE(url, '^https?://([^/]+).*', '\1')) as name,
        url
    FROM links
    WHERE deleted_at IS NULL
    ORDER BY created_at DESC
" 2>/dev/null)

# Overwrite bookmarks file with titles (will show on next restart)
sleep 0.3
cp "$TEMP_FILE" "$BOOKMARKS_FILE"
rm -f "$TEMP_FILE"

echo "message-info 'Synced $count phone bookmarks'" >> "$QUTE_FIFO"
echo "cmd-later 200 bookmark-list" >> "$QUTE_FIFO"
