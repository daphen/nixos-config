#!/bin/bash
# 1Password userscript - fill USERNAME only

DOMAIN=$(echo "$QUTE_URL" | sed -E 's|https?://([^/]+).*|\1|' | sed 's/^www\.//')
ITEM=$(op item list --format=json 2>/dev/null | jq -r ".[] | select(.urls[]?.href | test(\"$DOMAIN\"; \"i\")) | .id" | head -1)

if [ -z "$ITEM" ]; then
    echo "message-error 'No 1Password item found for $DOMAIN'" >> "$QUTE_FIFO"
    exit 1
fi

USERNAME=$(op item get "$ITEM" --fields username --reveal 2>/dev/null)

if [ -z "$USERNAME" ]; then
    echo "message-error '1Password: No username found'" >> "$QUTE_FIFO"
    exit 1
fi

echo "insert-text $USERNAME" >> "$QUTE_FIFO"
echo "message-info '1Password: Filled username'" >> "$QUTE_FIFO"
