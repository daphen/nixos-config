#!/bin/bash
# 1Password userscript for qutebrowser
# Fills username and password from 1Password CLI

# Get domain from current URL
DOMAIN=$(echo "$QUTE_URL" | sed -E 's|https?://([^/]+).*|\1|' | sed 's/^www\.//')

# Search for item matching the domain
ITEM=$(op item list --format=json 2>/dev/null | jq -r ".[] | select(.urls[]?.href | test(\"$DOMAIN\"; \"i\")) | .id" | head -1)

if [ -z "$ITEM" ]; then
    echo "message-error 'No 1Password item found for $DOMAIN'" >> "$QUTE_FIFO"
    exit 1
fi

# Get credentials
USERNAME=$(op item get "$ITEM" --fields username --reveal 2>/dev/null)
PASSWORD=$(op item get "$ITEM" --fields password --reveal 2>/dev/null)

if [ -z "$PASSWORD" ]; then
    echo "message-error '1Password: Could not retrieve credentials'" >> "$QUTE_FIFO"
    exit 1
fi

# Fill username if available, tab to password field, then fill password
if [ -n "$USERNAME" ]; then
    echo "insert-text $USERNAME" >> "$QUTE_FIFO"
    echo "cmd-later 50 fake-key <Tab>" >> "$QUTE_FIFO"
    echo "cmd-later 100 insert-text $PASSWORD" >> "$QUTE_FIFO"
else
    echo "insert-text $PASSWORD" >> "$QUTE_FIFO"
fi

echo "cmd-later 150 message-info '1Password: Filled credentials for $DOMAIN'" >> "$QUTE_FIFO"
