#!/usr/bin/env bash
# Focus workspace down, or monitor below if no non-empty workspaces below
# If at the bottom monitor, stay at current workspace (no new workspace created for focus)

# Get current workspace info
current_output=$(niri msg -j workspaces | jq -r '.[] | select(.is_active == true and .is_focused == true) | .output')
current_workspace=$(niri msg -j workspaces | jq -r '.[] | select(.is_active == true and .is_focused == true) | .idx')

# Get all workspaces on current output with windows, sorted by index
workspaces_with_windows=$(niri msg -j workspaces | jq -r --arg output "$current_output" '.[] | select(.output == $output and .active_window_id != null) | .idx' | sort -n)

# Find the next workspace down that has windows
next_workspace_down=$(echo "$workspaces_with_windows" | awk -v current="$current_workspace" '$1 > current' | head -n1)

# If there's no workspace with windows below us, check if we can move to monitor below
if [ -z "$next_workspace_down" ]; then
    # Get current output Y position
    current_y=$(niri msg -j outputs | jq -r --arg output "$current_output" '.[$output].logical.y')

    # Check if there's any monitor below the current one (with greater Y value)
    monitor_below=$(niri msg -j outputs | jq -r --argjson current_y "$current_y" 'to_entries[] | select(.value.logical.y > $current_y) | .key' | head -n1)

    if [ -n "$monitor_below" ]; then
        # There's a monitor below, focus it
        niri msg action focus-monitor-down
    fi
    # If we're at the bottom monitor with no workspaces below, do nothing
else
    # Jump directly to that workspace
    niri msg action focus-workspace "$next_workspace_down"
fi
