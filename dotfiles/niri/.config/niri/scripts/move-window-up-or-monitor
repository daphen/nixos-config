#!/usr/bin/env bash
# Move window up to previous workspace, or to monitor above if no other workspaces with windows above
# If at the top monitor, create a new workspace above

# Get current workspace info
current_output=$(niri msg -j workspaces | jq -r '.[] | select(.is_active == true and .is_focused == true) | .output')
current_workspace=$(niri msg -j workspaces | jq -r '.[] | select(.is_active == true and .is_focused == true) | .idx')

# Get all workspaces on current output with windows (excluding current), sorted by index
workspaces_with_windows=$(niri msg -j workspaces | jq -r --arg output "$current_output" --argjson current "$current_workspace" '.[] | select(.output == $output and .active_window_id != null and .idx != $current) | .idx' | sort -n)

# Find if there are any workspaces with windows above us
next_workspace_up=$(echo "$workspaces_with_windows" | awk -v current="$current_workspace" '$1 < current' | tail -n1)

# If there's no workspace with windows above us, check if we can move to monitor above
if [ -z "$next_workspace_up" ]; then
    # Get current output Y position
    current_y=$(niri msg -j outputs | jq -r --arg output "$current_output" '.[$output].logical.y')

    # Check if there's any monitor above the current one (with smaller Y value)
    monitor_above=$(niri msg -j outputs | jq -r --argjson current_y "$current_y" 'to_entries[] | select(.value.logical.y < $current_y) | .key' | head -n1)

    if [ -n "$monitor_above" ]; then
        # There's a monitor above, move window there
        niri msg action move-window-to-monitor-up
    else
        # We're at the top monitor, create a new workspace above and move window there
        niri msg action move-window-to-workspace-up
    fi
else
    # Otherwise, move to workspace up
    niri msg action move-window-to-workspace-up
fi
