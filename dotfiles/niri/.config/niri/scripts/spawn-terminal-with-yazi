#!/bin/bash
# Spawn a new terminal at the same directory as the focused window and run yazi

# Debug log file
DEBUG_LOG="/tmp/yazi-spawn-debug.log"
echo "=== Debug $(date) ===" > "$DEBUG_LOG"

# Get the PID of the currently focused window
FOCUSED_PID=$(niri msg --json windows | python3 -c "
import sys, json
windows = json.load(sys.stdin)
for w in windows:
    if w.get('is_focused', False):
        print(w.get('pid', ''))
        break
")

echo "Focused PID: $FOCUSED_PID" >> "$DEBUG_LOG"

# If we found a focused window with a PID, try to get its working directory
if [ -n "$FOCUSED_PID" ] && [ "$FOCUSED_PID" != "None" ]; then
    echo "Found focused window PID: $FOCUSED_PID" >> "$DEBUG_LOG"

    # List all child processes
    echo "Child processes of $FOCUSED_PID:" >> "$DEBUG_LOG"
    pgrep -P "$FOCUSED_PID" | while read pid; do
        comm=$(cat /proc/$pid/comm 2>/dev/null)
        cwd=$(readlink -f /proc/$pid/cwd 2>/dev/null)
        echo "  PID $pid: $comm (cwd: $cwd)" >> "$DEBUG_LOG"
    done

    # Try to find a shell process under this PID and get its cwd
    # Sort by PID in reverse order (highest/newest first) to get the most recent shell
    SHELL_PID=$(pgrep -P "$FOCUSED_PID" | sort -rn | while read pid; do
        comm=$(cat /proc/$pid/comm 2>/dev/null)
        if [[ "$comm" =~ ^(fish|bash|zsh)$ ]]; then
            echo $pid
            break
        fi
    done | head -n1)

    echo "Shell PID (most recent): $SHELL_PID" >> "$DEBUG_LOG"

    # If we found a shell, get its cwd
    if [ -n "$SHELL_PID" ]; then
        CWD=$(readlink -f /proc/$SHELL_PID/cwd 2>/dev/null)
        echo "Found CWD from shell: $CWD" >> "$DEBUG_LOG"
    fi
else
    echo "No focused PID found" >> "$DEBUG_LOG"
fi

# Fallback to home directory if we couldn't determine the cwd
CWD="${CWD:-$HOME}"
echo "Final CWD: $CWD" >> "$DEBUG_LOG"

# Spawn kitty at the determined directory and run yazi with that directory
kitty --directory "$CWD" yazi "$CWD"